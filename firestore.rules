rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // User profiles
    match /users/{userId} {
      // Users can read their own profile and admins can read all
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
      
      // Users can write their own profile (limited fields)
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Admins can update any user's role
      allow update: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // Contract metadata
    match /contracts/{contractId}/meta/{document=**} {
      // All authenticated users can read contract metadata
      allow read: if request.auth != null;
      
      // Only admins can create/update contract metadata
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // Contract clauses
    match /contracts/{contractId}/clauses/{clauseId} {
      // Any logged-in user can read clauses
      allow read: if request.auth != null;

      // Admin and Editor can create/update
      allow create, update: if request.auth != null &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin" ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "editor"
        );

      // Only Admin can delete clauses
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
  }
}
